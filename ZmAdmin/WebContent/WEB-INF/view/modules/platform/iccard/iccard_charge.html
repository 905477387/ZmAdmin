<!-- 
 * Generated by Blade.
 * 2017-09-09 15:42:39
 -->
@layout("/common/_container.html"){

<style>
    td{
        vertical-align: middle !important;
    }
</style>
<div class="page-header-form">
    <h2>
        充值信息
        <small>
            <i class="ace-icon fa fa-angle-double-right">
                金额
            </i>
        </small>
    </h2>
</div>
<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>企业名称</th>
            <th>车牌号</th>
            <th>驾驶员</th>
            <th>会员卡号</th>
            <th>卡内余额</th>
            <th>充值</th>
            <th>状态</th>
        </tr>
    </thead>
    <tbody>
        @ for (x in list) {
            <tr>
                <td>${x.CustName!}</td>
                <td>${x.CarNo!}</td>
                <td>${x.HolderName!}</td>
                <td>${x.CardNo!}</td>
                <td style="text-align: right;">${x.Balance!}</td>
                <td><input type="number" name="ChargeBalance"
                           data-card-no="${x.CardNo!}"
                           data-cust-no="${x.CustNo!}"
                           data-cust-name="${x.CustName!}"
                           data-car-no="${x.CarNo!}"
                           data-holder-name="${x.HolderName!}"
                           data-balance="${x.Balance!}"
                           min="50" class="form-control" placeholder="请输入充值金额" /></td>
                <td style="text-align: center;">
                    <span class="label label-info arrowed arrowed-right">
                        待充值
                    </span>
                </td>
            </tr>
        @ }
    </tbody>
    <tfoot>
        <tr>
            <th>合计</th>
            <td colspan="6" style="text-align: center;">
                <span style="color: red; font-weight: bold;">
                    充值总金额 ：<span id="sp_total">0</span>元
                </span>
            </td>
        </tr>
    </tfoot>
</table>
<div class="page-header-form">
    <h2>
        充值信息
        <small>
            <i class="ace-icon fa fa-angle-double-right">
                凭证
            </i>
        </small>
    </h2>
</div>
<table class="table table-bordered table-striped">
    <tr>
        <td style="text-align:right;">中民能源开户行</td>
        <td>
            <input class="form-control" id="BankName" placeholder="请输入开户行" />
        </td>
        <td style="text-align:right;">中民能源油款充值账户</td>
        <td>
            <input class="form-control" disabled id="BankNo_ipt" placeholder="请先选择开户行"/>
            <input class="form-control" type="hidden" id="BankNo" placeholder="请先选择开户行"/>
        </td>
    </tr>
    <tr id="tr_bank"></tr>
    <tr>
        <td style="text-align:right;">流水号</td>
        <td colspan="3"><input class="form-control" id="OrderNo" placeholder="请输入流水号"/></td>
    </tr>
</table>
@ include("/common/_curd/_btn_diy2.html",{btn_save:"提交",btn_close:"关闭"}) {}


<script src="${ctxPath}/static/blade/js/blade-toolbox.js" type="text/javascript"></script>
<script src="${ctxPath}/static/blade/js/blade-combotree.js" type="text/javascript"></script>
<script>


    $(function () {
        var combotree = new BladeComboTree();
        combotree.setId("BankName");
        combotree.setSource("bank.combo");
        combotree.setCheck("radio");
        combotree.setHeight("150px");
        combotree.init();
    })

    function comboTreeCallBackTail(id, val) {
        $("#BankNo_ipt").val(val);
        $("#BankNo").val(val);
    }

    var Total = 0;

    $("input[name='ChargeBalance']").bind('blur', function () {
        Total = 0;
        $("input[name='ChargeBalance']").each(function(i){
            var cb = $(this).val();
            if (BladeTool.isNotEmpty(cb)) {
                Total += parseFloat(cb);
            }
        });
        $("#sp_total").html(Total.toFixed(2));
    })

    $("#btn_save").bind("click",function(){

        if (BladeTool.isEmpty($("#BankName_ipt").val().trim())) {
            layer_alert("请选择开户行", "warn");
            return false;
        }
        if (BladeTool.isEmpty($("#OrderNo").val())) {
            layer_alert("请输入流水号", "warn");
            return false;
        }

        var flag = true;
        var list = [];
        $("input[name='ChargeBalance']").each(function(i){
            var cb = $(this).val();
            if (BladeTool.isEmpty(cb)) {
                layer_alert("请先输入充值金额!", "warn");
                flag = false;
                return false;
            }
            var json = {};
            json.CardNo = $(this).attr("data-card-no");
            json.CustNo = $(this).attr("data-cust-no");
            json.CustName = $(this).attr("data-cust-name");
            json.CarNo = $(this).attr("data-car-no");
            json.HolderName = $(this).attr("data-holder-name");
            json.Balance = $(this).attr("data-balance");
            json.ChargeBalance = $(this).val();
            list.push(json);
        });

        if (flag) {
            layer.confirm('是否提交充值申请？', {
                icon: 3,
                btn: ['确定', '取消'] //按钮
            }, function () {
                var ajax = new Ajax("${ctxPath}/iccard/pushCharge", function (data) {
                    if (data.code === 0) {
                        layer.msg(data.message, {shift: 1});
                        setTimeout(function(){
                            window.top.reloadTabById("iccard");
                            window.top.autoClose("top_iccard_charge","iccard");
                        },500);
                    } else {
                        layer_alert(data.message, "error")
                    }
                });
                ajax.set("list", JSON.stringify(list));
                ajax.set("BankName", $("#BankName_ipt").val());
                ajax.set("BankNo", $("#BankNo").val());
                ajax.set("OrderNo", $("#OrderNo").val());
                ajax.set("CustNo", "${CustNo!}");
                ajax.set("CustName", "${CustName!}");
                ajax.set("Total", $("#sp_total").html());
                ajax.start();
            }, function () {
                //layer.msg('已取消');
            });
        }
    });

    $("#btn_close").bind("click",function(){
        window.top.reloadTabById("iccard");
        window.top.autoClose("top_iccard_charge","iccard");
    });

</script>

@}	